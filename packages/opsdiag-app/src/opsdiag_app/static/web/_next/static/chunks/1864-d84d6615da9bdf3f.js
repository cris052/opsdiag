"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1864],{31217:(e,t,r)=>{r.d(t,{A:()=>U});var l=r(95155),n=r(29639),s=r(56196),i=r(12115),a=r(59622),o=r(91070),c=r(78966),u=r.n(c),d=r(51368),h=r(28867),m=r(91573),p=r(37974),f=r(69068),x=r.n(f),g=r(91218),v=r(54099),w=r(76572),y=r(77079);let b=e=>{var t;let{isScrollToTop:r}=e,{message:n}=y.A.useApp(),{appInfo:s,refreshAppInfo:a}=(0,i.useContext)(o.zo),{t:c}=(0,g.Bd)(),u=(0,i.useMemo)(()=>{var e;return(null==s||null==(e=s.team_context)?void 0:e.chat_scene)||"chat_agent"},[s]),d=(0,i.useMemo)(()=>(null==s?void 0:s.icon)||"",[s]),f=(0,i.useMemo)(()=>(null==s?void 0:s.is_collected)==="true",[s]),{run:b,loading:j}=(0,v.A)(async()=>{let[e]=await (0,h.Vb)(f?(0,h.bQ)({app_code:s.app_code}):(0,h.cT)({app_code:s.app_code}));if(!e)return await a()},{manual:!0});if((0,i.useMemo)(()=>{var e;return(null==(e=s.param_need)?void 0:e.map(e=>e.type))||[]},[s.param_need]),!Object.keys(s).length)return null;let N=async()=>{let e=x()(location.href);n[e?"success":"error"](e?c("copy_success"):c("copy_failed"))};return(0,l.jsx)("div",{className:"mt-1 mb-4 bg-[#E0E7F2] ".concat((null==s?void 0:s.recommend_questions)&&(null==s||null==(t=s.recommend_questions)?void 0:t.length)>0?"mb-4":""," sticky top-0 bg-transparent z-30 transition-all duration-400 ease-in-out shadow-[0_4px_12px_-4px_rgba(0,0,0,0.08)]"),children:(()=>{var e,t;return(0,l.jsxs)("header",{className:"flex items-center justify-between w-full h-14 bg-[#F1F5F9] dark:bg-[rgba(41,63,89,0.4)]  px-8 transition-all duration-500 ease-in-out py-2",children:[(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-lg mr-2 bg-white",children:d?(0,l.jsx)("img",{src:d,alt:null==s?void 0:s.app_name,className:"w-8 min-w-8 rounded-full max-w-none"}):(0,l.jsx)(w.A,{scene:u,width:16,height:16})}),(0,l.jsxs)("div",{className:"flex items-center text-base text-[#1c2533] dark:text-[rgba(255,255,255,0.85)] font-semibold gap-2",children:[(0,l.jsx)("span",{children:null==s?void 0:s.app_name}),(0,l.jsxs)("div",{className:"flex gap-1",children:[(null==s?void 0:s.team_mode)&&(0,l.jsx)(p.A,{color:"green",children:null==s?void 0:s.team_mode}),(null==s||null==(e=s.team_context)?void 0:e.chat_scene)&&(0,l.jsx)(p.A,{color:"cyan",children:null==s||null==(t=s.team_context)?void 0:t.chat_scene})]})]})]}),(0,l.jsx)("div",{className:"flex gap-8",onClick:async()=>{await b()},children:(0,l.jsx)(m.A,{className:"text-lg",onClick:e=>{e.stopPropagation(),N()}})})]})})()})};var j=r(66551),N=r(81702),S=r(3231),k=r(53867),A=r(91479),_=r(45163),O=r(92199),P=r(29300),T=r.n(P),E=r(66766);let C=()=>{var e;let t=JSON.parse(null!=(e=localStorage.getItem(N.Gm))?e:""),r=(null==t?void 0:t.avatar_url)||"/agents/sre.png";return(0,l.jsx)(E.default,{className:"rounded-full border border-gray-200 object-contain bg-white inline-block",width:32,height:32,src:r,alt:"User Avatar"})},J={todo:{bgClass:"bg-gray-500",icon:(0,l.jsx)(S.A,{className:"ml-2"})},runing:{bgClass:"bg-blue-500",icon:(0,l.jsx)(k.A,{className:"ml-2"})},failed:{bgClass:"bg-red-500",icon:(0,l.jsx)(A.A,{className:"ml-2"})},completed:{bgClass:"bg-green-500",icon:(0,l.jsx)(_.A,{className:"ml-2"})}},M=e=>e.replaceAll("\\n","\n").replace(/<table(\w*=[^>]+)>/gi,"<table $1>").replace(/<tr(\w*=[^>]+)>/gi,"<tr $1>"),V=(0,i.memo)(e=>{let{content:t,onLinkClick:r,messages:n}=e,{t:s}=(0,g.Bd)(),{context:a,role:o,thinking:c}=t,u=(0,i.useMemo)(()=>"view"===o,[o]),{value:d,cachePluginContext:h}=(0,i.useMemo)(()=>{if("string"!=typeof a)return{relations:[],value:"",cachePluginContext:[]};let[e,t]=a.split("	relations:"),r=t?t.split(","):[],l=[],n=0,s=e.replace(/<dbgpt-view[^>]*>[^<]*<\/dbgpt-view>/gi,e=>{try{var t;let r=e.replaceAll("\n","\\n").replace(/<[^>]*>|<\/[^>]*>/gm,""),s=JSON.parse(r),i="<custom-view>".concat(n,"</custom-view>");return l.push({...s,result:M(null!=(t=s.result)?t:"")}),n++,i}catch(t){return console.log(t.message,t),e}});return{relations:r,cachePluginContext:l,value:s}},[a]),m=(0,i.useMemo)(()=>({"custom-view"(e){var t;let{children:r}=e,n=+r.toString();if(!h[n])return r;let{name:s,status:i,err_msg:a,result:o}=h[n],{bgClass:c,icon:u}=null!=(t=J[i])?t:{};return(0,l.jsxs)("div",{className:"bg-white dark:bg-[#212121] rounded-lg overflow-hidden my-2 flex flex-col lg:max-w-[80%]",children:[(0,l.jsxs)("div",{className:T()("flex px-4 md:px-6 py-2 items-center text-white text-sm",c),children:[s,u]}),o?(0,l.jsx)("div",{className:"px-4 md:px-6 py-4 text-sm",children:(0,l.jsx)(O.A,{components:j.Ay,...j.iU,children:(0,j.Jg)(null!=o?o:"")})}):(0,l.jsx)("div",{className:"px-4 md:px-6 py-4 text-sm",children:a})]})}}),[h]),p=function(e){try{return JSON.parse(e)}catch(e){return{left:"",right:""}}}(a),f=null==p?void 0:p.planning_window,x=void 0!==f?f:d;return(0,l.jsxs)(l.Fragment,{children:[!u&&(0,l.jsxs)("div",{className:"flex flex-1 justify-end items-start pb-4",style:{gap:12},children:[(0,l.jsx)("span",{className:"break-words text-right",style:{maxWidth:"100%",minWidth:0},children:"string"==typeof a?(0,l.jsx)("div",{className:"flex-1 text-sm text-[#1c2533] dark:text-white",style:{whiteSpace:"pre-wrap",wordBreak:"break-word"},children:"string"==typeof a&&(0,l.jsx)("div",{children:(0,l.jsx)(O.A,{components:{...j.Ay,img:e=>{let{src:t,alt:r,...n}=e;return(0,l.jsx)("img",{src:t,alt:r||"image",className:"max-w-full md:max-w-[80%] lg:max-w-[70%] object-contain",style:{maxHeight:"200px"},...n})}},...j.iU,children:(0,j.Jg)(M(d))})})}):(null==a?void 0:a.template_introduce)||""}),(0,l.jsx)(C,{})]}),u&&(0,l.jsxs)("div",{className:"flex flex-col pr-2 border-dashed border-r0 flex-1",children:[(0,l.jsx)(O.A,{components:{...j.Ay,...m},...j.iU,children:(0,j.Jg)((e=>null==e?void 0:e.replace(/<table(\w*=[^>]+)>/gi,"<table $1>").replace(/<tr(\w*=[^>]+)>/gi,"<tr $1>"))(x))}),c&&!a&&(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"flex text-sm text-[#1c2533] dark:text-white",children:s("thinking")}),(0,l.jsxs)("div",{className:"flex",children:[(0,l.jsx)("div",{className:"w-1 h-1 rounded-full mx-1 animate-pulse1"}),(0,l.jsx)("div",{className:"w-1 h-1 rounded-full mx-1 animate-pulse2"}),(0,l.jsx)("div",{className:"w-1 h-1 rounded-full mx-1 animate-pulse3"})]})]})]})]})}),R=(0,i.memo)(e=>{var t;let{ctrl:r}=e,n=(0,i.useRef)(null),{history:s,isDebug:c,isShowDetail:h}=(0,i.useContext)(o.zo),[m,p]=(0,i.useState)(!1),[f,x]=(0,i.useState)(""),g=(0,i.useMemo)(()=>u()(s).filter(e=>["view","human"].includes(e.role)).map(e=>({...e,key:(0,d.A)()})),[s]);return(0,i.useEffect)(()=>{setTimeout(()=>{var e,t;null==(t=n.current)||t.scrollTo(0,null==(e=n.current)?void 0:e.scrollHeight)},50)},[s,null==(t=s[s.length-1])?void 0:t.context]),console.log("Rendering content3...",r),(0,l.jsx)("div",{className:"flex flex-1 h-full",children:(0,l.jsx)("div",{className:"".concat(c?"bg-[transparent]":"bg-white"," dark:bg-[rgba(255,255,255,0.16)] flex flex-1 flex-col p-2 items-center relative"),ref:n,children:(0,l.jsxs)("div",{className:"flex flex-col flex-1 ".concat(h?"w-3/5":"w-full"," h-full"),children:[(0,l.jsxs)("div",{className:"flex-1 overflow-y-scroll",children:[(0,l.jsx)(b,{isScrollToTop:!0}),!!g.length&&g.map((e,t)=>(0,l.jsx)(V,{content:e,onLinkClick:()=>{p(!0),x(JSON.stringify(null==e?void 0:e.context,null,2))},messages:g},t))]}),(0,l.jsx)("div",{className:"w-full flex justify-center",children:(0,l.jsx)("div",{className:"w-full",children:(0,l.jsx)(a.A,{ctrl:r})})})]})})})});var F=r(70061);let H=(0,i.memo)(e=>{let{content:t}=e;return(0,l.jsx)(l.Fragment,{children:(0,l.jsx)("div",{className:"flex flex-col border-dashed border-r0 flex-1 h-full",children:(0,l.jsx)(O.A,{components:{...j.Ay},...j.iU,children:t})})})}),I=(0,i.memo)(e=>{var t;let{ctrl:r}=e,n=(0,i.useRef)(null),s=(0,i.useRef)(null),{history:c,isShowDetail:h,isDebug:m}=(0,i.useContext)(o.zo),{runningWindowMarkdown:p}=function(e){let[t,r]=(0,i.useState)("");return(0,i.useEffect)(()=>{if(!Array.isArray(e))return void r("");let t="";for(let r of e)try{if("string"==typeof r.context&&!r.context.trim().startsWith("{"))continue;let e=("string"==typeof r.context?JSON.parse(r.context):r.context).running_window||"";e&&"string"==typeof e&&(t=t?(0,F.cc)(t,e||""):e||"")}catch(e){console.debug("Skipping invalid chat item context:",{error:e instanceof Error?e.message:String(e),itemId:(null==r?void 0:r.id)||(null==r?void 0:r.order),contextSample:"string"==typeof(null==r?void 0:r.context)?r.context.substring(0,50):"[non-string context]"})}r(t)},[e]),{runningWindowMarkdown:t}}(c),[f,x]=(0,i.useState)(!1),[g,v]=(0,i.useState)(""),w=(0,i.useMemo)(()=>u()(c).filter(e=>["view","human"].includes(e.role)).map(e=>({...e,key:(0,d.A)()})),[c]);return(0,i.useEffect)(()=>{setTimeout(()=>{var e,t;null==(t=n.current)||t.scrollTo(0,null==(e=n.current)?void 0:e.scrollHeight)},50)},[c,null==(t=c[c.length-1])?void 0:t.context]),(0,l.jsx)("div",{className:"flex flex-1 h-full w-full ",children:(0,l.jsxs)("div",{className:"".concat(m?"bg-[transparent]":"bg-white","  dark:bg-[rgba(255,255,255,0.16)] flex flex-1 p-2 justify-center flex-1 w-full"),children:[(0,l.jsxs)("div",{className:"flex flex-col w-2/5 pr-2 border-gray-300 flex-1",children:[(0,l.jsxs)("div",{className:"h-full flex-1 overflow-y-scroll",ref:s,children:[(0,l.jsx)(b,{isScrollToTop:!0}),!!w.length&&w.map((e,t)=>(0,l.jsx)(V,{content:e,onLinkClick:()=>{x(!0),v(JSON.stringify(null==e?void 0:e.context,null,2))},messages:w},t))]}),(0,l.jsx)("div",{className:"w-full flex justify-center",children:(0,l.jsx)(a.A,{ctrl:r})})]}),h&&(0,l.jsx)("div",{className:"flex flex-col w-3/5 pl-2 border-dashed border-l border-[#F1F5F9] h-full",id:"running-window",children:(0,l.jsx)(H,{content:p})})]})})}),U=(0,i.memo)((0,i.forwardRef)((e,t)=>{var r,a,c,u;let{ctrl:d}=e,{appInfo:h}=(0,i.useContext)(o.zo),m=(0,i.useRef)(null),[p,f]=(0,i.useState)(!1),[x,g]=(0,i.useState)(!1),[v,w]=(0,i.useState)(!0),[y,b]=(0,i.useState)(!1);(0,i.useImperativeHandle)(t,()=>m.current);let j=()=>{if(!m.current)return;let e=m.current,t=e.scrollTop,r=e.scrollHeight,l=e.clientHeight;w(t<=20),b(t+l>=r-20),t>=74?f(!0):f(!1),g(r>l)};(0,i.useEffect)(()=>(m.current&&(m.current.addEventListener("onScroll",j),g(m.current.scrollHeight>m.current.clientHeight)),()=>{m.current&&m.current.removeEventListener("onScroll",j)}),[]);let N=(0,i.useMemo)(()=>{var e,t,r,l;return(null==h||null==(t=h.layout)||null==(e=t.chat_layout)?void 0:e.reuse_name)==="derisk_vis_window"||(null==h||null==(l=h.layout)||null==(r=l.chat_layout)?void 0:r.name)==="derisk_vis_window"},[null==h||null==(a=h.layout)||null==(r=a.chat_layout)?void 0:r.name,null==h||null==(u=h.layout)||null==(c=u.chat_layout)?void 0:c.reuse_name]);return(0,l.jsxs)("div",{className:"flex flex-1 relative h-full",children:[(0,l.jsx)("div",{ref:m,className:"h-full w-full flex-1 flex flex-col overflow-hidden",children:N?(0,l.jsx)(I,{ctrl:d}):(0,l.jsx)(R,{ctrl:d})}),x&&(0,l.jsxs)("div",{className:"absolute right-6 bottom-24 flex flex-col gap-2",children:[!v&&(0,l.jsx)("button",{onClick:()=>{m.current&&m.current.scrollTo({top:0,behavior:"smooth"})},className:"w-10 h-10 bg-white dark:bg-[rgba(255,255,255,0.2)] border border-gray-200 dark:border-[rgba(255,255,255,0.2)] rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-shadow","aria-label":"Scroll to top",children:(0,l.jsx)(n.A,{className:"text-[#525964] dark:text-[rgba(255,255,255,0.85)]"})}),!y&&(0,l.jsx)("button",{onClick:()=>{m.current&&m.current.scrollTo({top:m.current.scrollHeight,behavior:"smooth"})},className:"w-10 h-10 bg-white dark:bg-[rgba(255,255,255,0.2)] border border-gray-200 dark:border-[rgba(255,255,255,0.2)] rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-shadow","aria-label":"Scroll to bottom",children:(0,l.jsx)(s.A,{className:"text-[#525964] dark:text-[rgba(255,255,255,0.85)]"})})]})]})}))},70061:(e,t,r)=>{r.d(t,{cc:()=>g,yh:()=>w});var l=r(97124),n=r.n(l),s=r(60363),i=r.n(s),a=r(71965),o=r(94793),c=r(96705),u=r(54514),d=r(36174);let h=(e,t)=>(function(e){let t=(null==e?void 0:e.remarkPlugins)||[],r={allowDangerousHtml:!0,...null==e?void 0:e.remarkRehypeOptions};return(0,u.l)().use(a.A).use(t).use(c.A,r)})(t).parse(function(e){let t=e.children||"",r=new d.T;return"string"==typeof t?r.value=t:console.error("Unexpected value `"+t+"` for `children` prop, expected `string`"),r}({children:e})),m=e=>(0,u.l)().use(o.A).stringify(e).trimEnd(),p=(e,t,r)=>{let l,{markdown:s="",uid:a,type:o,items:c=[],dynamic:u}=e,{markdown:d="",uid:h,type:m,items:f=[],dynamic:x}=t;if(a!==h)return e;let v=u?s+d:g(s,d,r);if(l="all"===m?d:"incr"===o||d?v:s,0!==f.length){let s=f.filter(e=>!n()(c,{uid:e.uid})),o=i()(f,"uid"),u=c.map(e=>o[e.uid]?p(e,o[e.uid],r):e);return{...e,...t,markdown:l||void 0,uid:a,dynamic:x,type:m,items:[...u,...s]}}return{...e,...t,markdown:l,uid:a,dynamic:x,type:m,items:c}},f=(e,t,r)=>{let l=r||(e=>{let t=new Map,r=e=>{let l=e=>{t.set(e.uid,e),e.markdown&&r(h(e.markdown)),e.items&&e.items.forEach(e=>{e.markdown&&r(h(e.markdown))})};if(e.hasOwnProperty("children"))e.children&&e.children.forEach(e=>r(e));else if(e.hasOwnProperty("lang")&&e.value)try{let t=JSON.parse(e.value);(t.items||[]).forEach(e=>{l(e)}),l(t)}catch(e){}};return r(e),t})(t),n=e=>{if(e.hasOwnProperty("children"))e.children.map(e=>n(e));else if(e.hasOwnProperty("lang")&&e.value)try{let t=JSON.parse(e.value),r=l.get(t.uid),n=r?p(t,r):t;e.value=JSON.stringify(n)}catch(e){}return e};return n(e),e},x=e=>{let t=e.match(/`/g);return!t||t.length<6},g=(e,t,r)=>{if(!e||!t)return e||t||void 0;if(x(e)||x(t)||!e.includes("```")&&!t.includes("```"))return e+t;let l=h(e),n=h(t);return l.hasOwnProperty("children")&&n.hasOwnProperty("children")?((e,t,r)=>{if(e.hasOwnProperty("children")&&t.hasOwnProperty("children")){let l=JSON.stringify(e);t.children.forEach(t=>{if(t.hasOwnProperty("lang")&&t.value)try{let n=JSON.parse(t.value).uid;if(l.includes(n)){let l=e.children.find(e=>{var t;return null==(t=e.value)?void 0:t.includes(n)});if(l){let e=f(l,t,r);l.value=e.value}}else e.children.push(t)}catch(e){}})}return m(e)})(l,n,r):m(f(l,n,r))};class v{destroy(){var e;null==(e=this.incrNodesMap)||e.clear()}createFile(e){let t=e.children||"",r=new d.T;return"string"==typeof t?r.value=t:console.error("Unexpected value `"+t+"` for `children` prop, expected `string`"),r}createTree2StringProcessor(){return(0,u.l)().use(o.A)}createString2TreeProcessor(e){let t=(null==e?void 0:e.remarkPlugins)||[],r={allowDangerousHtml:!0,...null==e?void 0:e.remarkRehypeOptions};return(0,u.l)().use(a.A).use(t).use(c.A,r)}parseVis2AST(e){return this.string2TreeProcessor.parse(this.createFile({children:e}))}parseAST2Vis(e){return this.tree2StringProcessor.stringify(e).trimEnd()}combineVisItem(e,t){let r,{markdown:l="",uid:s,type:a,items:o=[],dynamic:c}=e,{markdown:u="",uid:d,type:h,items:m=[],dynamic:p}=t;if(s!==d)return e;let f=c?l+u:this.combineMarkdownString(l,u);if(r="all"===h?u:"incr"===a||u?f:l,0!==m.length){let l=m.filter(e=>!n()(o,{uid:e.uid})),a=i()(m,"uid"),c=o.map(e=>a[e.uid]?this.combineVisItem(e,a[e.uid]):e);return{...e,...t,markdown:r||void 0,uid:s,dynamic:p,type:h,items:[...c,...l]}}return{...e,...t,markdown:r,uid:s,dynamic:p,type:h,items:o}}getIncrContent(e){this.incrNodesMap.clear();let t=e=>{let r=e=>{this.incrNodesMap.set(e.uid,e),e.markdown&&t(this.parseVis2AST(e.markdown)),e.items&&e.items.forEach(e=>{e.markdown&&t(this.parseVis2AST(e.markdown))})};if(e.hasOwnProperty("children"))e.children&&e.children.forEach(e=>t(e));else if(e.hasOwnProperty("lang")&&e.value)try{let t=JSON.parse(e.value);(t.items||[]).forEach(e=>{r(e)}),r(t)}catch(e){}};t(e)}updateAST(e){let t=e=>{if(e.hasOwnProperty("children"))e.children.map(e=>t(e));else if(e.hasOwnProperty("lang")&&e.value)try{let t=JSON.parse(e.value),r=this.incrNodesMap.get(t.uid),l=r?this.combineVisItem(t,r):t;e.value=JSON.stringify(l)}catch(e){}return e};return t(e),e}isPartialTag(e){let t=e.match(/`/g);return!t||t.length<6}combineNodeWithChildren(e,t){if(e.hasOwnProperty("children")&&t.hasOwnProperty("children")){let r=JSON.stringify(e);t.children.forEach(t=>{if(t.hasOwnProperty("lang")&&t.value)try{let l=JSON.parse(t.value).uid;if(r.includes(l)){let t=e.children.find(e=>{var t;return null==(t=e.value)?void 0:t.includes(l)});if(t){let e=this.updateAST(t);t.value=e.value}}else e.children.push(t)}catch(e){}})}return this.parseAST2Vis(e)}combineMarkdownString(e,t){if(!e||!t)return e||t||void 0;if(this.isPartialTag(e)||this.isPartialTag(t)||!e.includes("```")&&!t.includes("```"))return e+t;let r=this.parseVis2AST(e),l=this.parseVis2AST(t);if(r.hasOwnProperty("children")&&l.hasOwnProperty("children"))return this.combineNodeWithChildren(r,l);let n=this.updateAST(r);return this.parseAST2Vis(n)}updateCurrentMarkdown(e){if(!this.currentVis)return this.currentVis=e,this.currentVis;let t=this.parseVis2AST(e);this.getIncrContent(t);let r=this.combineMarkdownString(this.currentVis,e);return this.currentVis=r||"",this.currentVis}constructor(){this.incrNodesMap=new Map,this.string2TreeProcessor=this.createString2TreeProcessor(),this.tree2StringProcessor=this.createTree2StringProcessor(),this.currentVis=""}}class w{getCurrent(e){var t;return e?(null==(t=this.parsers.get(e))?void 0:t.current)||"":this.defaultParser.currentVis}update(e){try{let t=JSON.parse(e);Object.keys(t).forEach(e=>{let r=this.parsers.get(e);if(r)r.update(t[e]),t[e]=r.current;else{let r=new w;r.update(t[e]),this.parsers.set(e,r)}}),this.current=JSON.stringify(t)}catch(t){this.defaultParser.updateCurrentMarkdown(e),this.current=this.defaultParser.currentVis}return this.current}destroy(){this.parsers.clear()}constructor(){this.current="",this.parsers=new Map,this.defaultParser=new v}}},93640:(e,t,r)=>{r.d(t,{A:()=>d});var l=r(89638),n=r(47937),s=r(81702),i=r(95069),a=r(94326),o=r(12115),c=r(70061),u=r(49509);let d=e=>{let{queryAgentURL:t="/api/v1/chat/completions",app_code:r}=e,[d,h]=(0,o.useState)({});return{chat:(0,o.useCallback)(async e=>{var o,d,m;let{data:p,onMessage:f,onClose:x,onDone:g,onError:v,ctrl:w}=e;if(w&&h(w),!(null==p?void 0:p.user_input)&&!(null==p?void 0:p.doc_id))return void a.Ay.warning(l.A.t("no_context_tip"));let y={...p,app_code:r},b=null==p||null==(o=p.ext_info)?void 0:o.incremental,j="",N={nodeId:"",text:""},S=new c.yh;try{await (0,i.y)("".concat(null!=(d=u.env.NEXT_PUBLIC_API_BASE_URL)?d:"").concat(t),{method:"POST",headers:{"Content-Type":"application/json",[s.uz]:null!=(m=(0,n.F6)())?m:""},body:JSON.stringify(y),signal:w?w.signal:null,openWhenHidden:!0,async onopen(e){e.ok&&e.headers.get("content-type")===i.o||"application/json"===e.headers.get("content-type")&&e.json().then(e=>{null==f||f(e),null==g||g(),w&&w.abort()})},onclose(){w&&w.abort(),null==x||x()},onerror(e){throw console.log("err",e),Error(e)},onmessage:e=>{let t=e.data;try{if(b){let{answerText:e,midMsgObject:r}=function(e,t,r,l){let n=t||{nodeId:"",text:""},s=r.vis;return n.text=l.update(s),{answerText:e||"",midMsgObject:n}}(j,N,JSON.parse(t),S);j=e,t=r.text}else t=JSON.parse(t).vis}catch(e){t.replaceAll("\\n","\n")}"string"==typeof t?"[DONE]"===t?null==g||g():(null==t?void 0:t.startsWith("[ERROR]"))?null==v||v(null==t?void 0:t.replace("[ERROR]","")):null==f||f(t):(null==f||f(t),null==g||g())}})}catch(e){w&&w.abort(),null==v||v("Sorry, We meet some error, please try agin later.",e)}},[t,r]),ctrl:d}}}}]);