(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7709],{73332:(e,l,n)=>{"use strict";n.r(l),n.d(l,{default:()=>eS});var t=n(95155),a=n(28867),r=n(91070),o=n(54099),s=n(16467),i=n(35695),u=n(12115),d=n(95849),c=n(92611),p=n(18610),m=n(32570),v=n(55887),f=n(15438),x=n.n(f),h=n(3711),g=n.n(h),_=n(96194),y=n(98696),b=n(32013);let j=function(e){let{visible:l,onCancel:n,onAgentChange:s,form:i}=e,{appInfo:d}=(0,u.useContext)(r.BR),{data:c,run:p,loading:v}=(0,o.A)(async e=>await (0,a.BN)({type:e}),{manual:!0});(0,u.useEffect)(()=>{l&&p("app")},[l,p]);let f=(0,u.useMemo)(()=>{var e,l,n;return null==c||null==(n=c.data)||null==(l=n.data)||null==(e=l.filter(e=>"app_code"===e.param_name))?void 0:e.flatMap(e=>{var l;return(null==(l=e.valid_values)?void 0:l.map(e=>({...e,value:e.key,label:e.label,selected:!0})))||[]})},[c]);return(0,t.jsx)(_.A,{title:"关联Agent",open:l,onCancel:n,footer:[(0,t.jsx)(y.Ay,{onClick:n,children:"取消"},"cancel"),(0,t.jsx)(y.Ay,{type:"primary",onClick:()=>{let e=i.getFieldValue("agents")||[];s((null==e?void 0:e.map(e=>{let l=((null==d?void 0:d.resource_agent)||[]).find(l=>"app"===l.type&&(()=>{try{return JSON.parse(l.value||"{}").name===e}catch(e){return!1}})());if(l)return l;let n=null==f?void 0:f.find(l=>l.value===e);if(n){let{selected:e,...l}=n;return{type:"app",name:l.label,value:JSON.stringify({...l,value:n.key})}}}))||[])},children:"完成"},"submit")],width:600,height:400,children:(0,t.jsx)("div",{className:"mt-[24px]",children:(0,t.jsx)(m.A,{layout:"horizontal",className:"flex flex-col gap-4",form:i,children:(0,t.jsx)(m.A.Item,{label:"请选择Agent",name:"agents",children:(0,t.jsx)(b.A,{mode:"multiple",allowClear:!0,style:{width:"100%"},placeholder:"请选择Agent",loading:v,options:f,optionFilterProp:"label"})})})})})};var N=n(56939),w=n(21103),A=n(5813),k=n(66766),S=n(91218),C=n(71740);let O=[{value:"/icons/colorful-plugin.png",label:"agent0"},{value:"/agents/agent1.jpg",label:"agent1"},{value:"/agents/agent2.jpg",label:"agent2"},{value:"/agents/agent3.jpg",label:"agent3"},{value:"/agents/agent4.jpg",label:"agent4"},{value:"/agents/agent5.jpg",label:"agent5"}];function J(e){let{handleChangedIcon:l,onInputBlur:n}=e,{t:a,i18n:o}=(0,S.Bd)(),{appInfo:s}=(0,u.useContext)(r.BR),[i,d]=(0,u.useState)((null==s?void 0:s.icon)||"/agents/agent1.jpg"),[c,p]=(0,u.useState)(!1);return(0,u.useEffect)(()=>{(null==s?void 0:s.icon)&&d(s.icon)},[s]),(0,t.jsxs)("div",{className:"flex gap-6",children:[(0,t.jsx)("div",{className:"flex flex-col items-center gap-2",children:(0,t.jsx)("div",{className:"cursor-pointer rounded-md border-2 border-dashed border-gray-300 hover:border-[#0c75fc] p-2 transition-all duration-200",onClick:()=>p(!0),children:(0,t.jsx)(k.default,{src:i,width:48,height:48,alt:"app icon",className:"rounded-md"})})}),(0,t.jsxs)("div",{className:"flex-1 [&_.ant-form-item]:mb-4",children:[(0,t.jsx)(m.A.Item,{name:"app_name",required:!0,rules:[{required:!0,message:a("input_app_name")}],children:(0,t.jsx)(N.A,{placeholder:a("input_app_name"),autoComplete:"off",className:"h-10",onBlur:()=>n("app_name")})}),(0,t.jsx)(m.A.Item,{name:"app_describe",required:!0,rules:[{required:!0,message:a("Please_input_the_description")}],children:(0,t.jsx)(N.A.TextArea,{autoComplete:"off",placeholder:a("Please_input_the_description"),autoSize:{minRows:3},onBlur:()=>n("app_describe")})})]}),(0,t.jsx)(_.A,{title:a("App_icon"),open:c,onCancel:()=>p(!1),footer:null,width:500,children:(0,t.jsx)("div",{className:"grid grid-cols-6 gap-4 p-2",children:O.map(e=>(0,t.jsx)("div",{className:"cursor-pointer rounded-md border-2 transition-all duration-200 hover:border-[#0c75fc] p-2 text-center ".concat(i===e.value?"border-[#0c75fc] bg-[#f5faff]":"border-gray-200 hover:bg-gray-50"),onClick:()=>{var n;d(n=e.value),p(!1),l(n)},children:(0,t.jsx)(k.default,{src:e.value,width:48,height:48,alt:e.label,className:"rounded-md mx-auto mb-2"})},e.value))})})]})}function I(e){let{form:l,reasoningEngineOptions:n}=e,{t:s}=(0,S.Bd)(),{appInfo:i}=(0,u.useContext)(r.BR),{data:d,run:c}=(0,o.A)(async()=>await (0,a.rW)(),{manual:!0}),{data:p,run:v}=(0,o.A)(async e=>await (0,a.Db)(e),{manual:!0}),{data:f}=(0,o.A)(async()=>await (0,a.C5)("Agent")),x=(0,u.useMemo)(()=>{var e,l;return null==f||null==(l=f.data)||null==(e=l.data)?void 0:e.map(e=>({...e,value:e.name,label:"".concat(e.name," (").concat(e.desc,")")}))},[f]);(0,u.useEffect)(()=>{c(),v(i.llm_strategy||"priority")},[i.llm_strategy]);let h=(0,u.useMemo)(()=>{var e,l;return null==d||null==(l=d.data)||null==(e=l.data)?void 0:e.map(e=>({...e,value:e.value,label:e.name_cn}))},[d]),g=(0,u.useMemo)(()=>{var e,l;return null==p||null==(l=p.data)||null==(e=l.data)?void 0:e.map(e=>({...e,value:e,label:e}))},[p]),_=(0,u.useMemo)(()=>null==i?void 0:i.is_reasoning_engine_agent,[i]);return(0,t.jsxs)("div",{className:"flex flex-col gap-1 [&_.ant-form-item]:mb-4",children:[(0,t.jsx)(m.A.Item,{label:"Agent类型",name:"agent",rules:[{required:!0,message:"请选择 Agent 类型"}],children:(0,t.jsx)(b.A,{placeholder:s("input_app_name"),options:x,allowClear:!0,className:"h-10"})}),_&&(0,t.jsx)(m.A.Item,{name:"reasoning_engine",label:"推理引擎",rules:[{required:!0,message:"请选择推理引擎"}],children:(0,t.jsx)(b.A,{options:n,placeholder:"请选择推理引擎",className:"h-10"})}),(0,t.jsx)(m.A.Item,{label:"模型策略",name:"llm_strategy",rules:[{required:!0,message:"请选择模型策略"}],children:(0,t.jsx)(b.A,{options:h,placeholder:"请选择模型策略",className:"h-10"})}),(0,t.jsx)(m.A.Item,{label:"模型选择",name:"llm_strategy_value",rules:[{required:!0,message:"请选择模型"}],children:(0,t.jsx)(b.A,{mode:"multiple",allowClear:!0,options:g,placeholder:"请选择模型",className:"min-h-10"})})]})}function F(e){let{form:l,layoutDataOptions:n,chatConfigOptions:a,onInputBlur:r,resourceOptions:o,modelOptions:s}=e,i=m.A.useWatch("chat_in_layout",l);return(0,t.jsxs)("div",{className:"flex flex-col gap-1 [&_.ant-form-item]:mb-4",children:[(0,t.jsx)(m.A.Item,{label:"布局方式",name:"chat_layout",rules:[{required:!0,message:"请选择布局方式"}],children:(0,t.jsx)(b.A,{options:n,placeholder:"请选择布局方式",className:"h-10"})}),(0,t.jsx)(m.A.Item,{label:"对话配置",name:"chat_in_layout",rules:[{required:!1,message:"请选择对话配置"}],children:(0,t.jsx)(w.A.Group,{options:a,className:"flex flex-wrap gap-2"})}),(0,t.jsx)(C.A,{form:l,selectedChatConfigs:i,chatConfigOptions:a,onInputBlur:r,resourceOptions:o,modelOptions:s})]})}let E=function(e){let{form:l,activeKey:n,setActiveKey:a,setIsCollapsed:r,layoutDataOptions:o,reasoningEngineOptions:s,handleChangedIcon:i,onInputBlur:u,chatConfigOptions:d,resourceOptions:c,modelOptions:p}=e,m=[{label:"基础信息",children:(0,t.jsx)(J,{form:l,handleChangedIcon:i,onInputBlur:u})},{label:"Agent配置",children:(0,t.jsx)(I,{form:l,reasoningEngineOptions:s})},{label:"界面布局",children:(0,t.jsx)(F,{form:l,layoutDataOptions:o,chatConfigOptions:d,onInputBlur:u,resourceOptions:c,modelOptions:p})}];return(0,t.jsx)("div",{className:"[&_.ant-collapse-header-text]:font-bold",children:(0,t.jsx)(A.A,{items:m,bordered:!1,activeKey:n,onChange:e=>{a(e),r(0===e.length)},collapsible:"header"})})},D=function(e){let{visible:l,onCancel:n,form:s,onKnowledgeChange:i}=e,{data:d,run:c,loading:p}=(0,o.A)(async e=>await (0,a.BN)({type:e}),{manual:!0}),{appInfo:v}=(0,u.useContext)(r.BR);(0,u.useEffect)(()=>{l&&c("knowledge")},[l,c]);let f=(0,u.useMemo)(()=>{var e,l,n;return null==d||null==(n=d.data)||null==(l=n.data)||null==(e=l.filter(e=>"knowledge"===e.param_name))?void 0:e.flatMap(e=>{var l;return(null==(l=e.valid_values)?void 0:l.map(e=>({...e,value:e.key,label:e.label,selected:!0})))||[]})},[d]);return(0,t.jsx)(_.A,{title:"关联知识",open:l,onCancel:n,footer:[(0,t.jsx)(y.Ay,{onClick:n,children:"取消"},"cancel"),(0,t.jsx)(y.Ay,{type:"primary",onClick:()=>{((e,l)=>{var n,t;let a=null==e?void 0:e.map(e=>{let n=l.find(l=>l.value===e);if(!n)return{value:e};let{selected:t,...a}=n;return{value:(null==n?void 0:n.key)||e,...a}}),r=(null==v?void 0:v.resource_knowledge)?null==v||null==(t=v.resource_knowledge)||null==(n=t[0])?void 0:n.value:"{}";i([{...(null==v?void 0:v.resource_knowledge)?v.resource_knowledge[0]:{},type:"knowledge_pack",value:JSON.stringify({...JSON.parse(r||"{}"),knowledges:a})}])})(s.getFieldValue("knowledge"),f)},children:"完成"},"submit")],width:600,height:400,children:(0,t.jsx)("div",{className:"mt-[24px]",children:(0,t.jsx)(m.A,{layout:"horizontal",className:"flex flex-col gap-4",form:s,children:(0,t.jsx)(m.A.Item,{label:"请选择知识库",name:"knowledge",children:(0,t.jsx)(b.A,{mode:"multiple",allowClear:!0,style:{width:"100%"},placeholder:"请选择知识库",loading:p,options:f,optionFilterProp:"label"})})})})})};var M=n(23512),B=n(6124),R=n(44261);let V=function(e){let{visible:l,onCancel:n,form:s,onToolsChange:i}=e,[d,c]=(0,u.useState)([]),[v,f]=(0,u.useState)("tool"),[x,h]=(0,u.useState)([]),{appInfo:g}=(0,u.useContext)(r.BR),{resource_tool:j}=g||{},{data:w,run:A,loading:k}=(0,o.A)(async e=>await (0,a.BN)({type:e}),{manual:!0});(0,u.useEffect)(()=>{l&&A("tool")},[l,A]);let S=(0,u.useMemo)(()=>{var e,l;return null==w||null==(l=w.data)||null==(e=l.data)?void 0:e.flatMap(e=>{var l;return(null==(l=e.valid_values)?void 0:l.map(e=>({...e,value:e.label,label:e.label,selected:!0})))||[]})},[w]),C=(0,u.useMemo)(()=>null==j?void 0:j.filter(e=>"tool(mcp(sse))"===e.type),[]);(0,u.useEffect)(()=>{l&&(A("tool"),h(C))},[l,A,C]);let O=(e,l,n)=>{let t=[...x];t[e]={...t[e],[l]:n},h(t)};return(0,t.jsx)(_.A,{title:"关联技能",open:l,onCancel:n,footer:[(0,t.jsx)(y.Ay,{onClick:n,children:"取消"},"cancel"),(0,t.jsx)(y.Ay,{type:"primary",onClick:()=>{n();let e=s.getFieldValue("tools")||[];i([...(null==e?void 0:e.map(e=>{let l=((null==g?void 0:g.resource_tool)||[]).find(l=>"tool"===l.type&&(()=>{try{return JSON.parse(l.value||"{}").name===e}catch(e){return!1}})());if(l)return l;let n=null==S?void 0:S.find(l=>l.label===e);if(n){let{selected:e,...l}=n;return{type:"tool",name:l.label,value:JSON.stringify({...l,value:n.key})}}}))||[],...x||[]])},children:"完成"},"submit")],width:600,height:400,children:(0,t.jsxs)("div",{className:"gap-4",children:[(0,t.jsx)(M.A,{defaultActiveKey:"tool",tabPosition:"top",onChange:e=>{f(e)},items:[{label:"工具集",key:"tool"},{label:"MCP",key:"mcp"}]}),"tool"===v?(0,t.jsx)(m.A,{layout:"horizontal",className:"flex flex-col gap-4 flex-1 mt-2",form:s,children:(0,t.jsx)(m.A.Item,{label:"请选择技能",name:"tools",children:(0,t.jsx)(b.A,{mode:"multiple",allowClear:!0,style:{width:"100%"},placeholder:"请选择技能",value:d,loading:k,options:S,onChange:c,optionFilterProp:"label"})})}):(0,t.jsxs)("div",{className:"flex flex-col gap-4 mt-2",children:[null==x?void 0:x.map((e,l)=>(0,t.jsx)(B.A,{size:"small",title:e.isNew?"新建 MCP ".concat(l+1):e.name,extra:(0,t.jsx)(y.Ay,{type:"text",icon:(0,t.jsx)(p.A,{}),onClick:()=>{h(x.filter((e,n)=>n!==l))},danger:!0,size:"small"}),className:"border-gray-200",children:(0,t.jsxs)(m.A,{layout:"vertical",size:"small",children:[(0,t.jsx)(m.A.Item,{label:"名称",className:"mb-2",children:(0,t.jsx)(N.A,{placeholder:"请输入MCP名称",value:e.name,onChange:e=>O(l,"name",e.target.value)})}),(0,t.jsx)(m.A.Item,{label:"请求头",className:"mb-2",children:(0,t.jsx)(N.A,{placeholder:"请输入Header",value:(()=>{try{return JSON.parse(e.value||"{}").headers||""}catch(e){return""}})(),onChange:n=>{let t={};try{t=JSON.parse(e.value||"{}")}catch(e){t={}}t.headers=n.target.value,O(l,"value",JSON.stringify(t))}})}),(0,t.jsx)(m.A.Item,{label:"服务",className:"mb-0",children:(0,t.jsx)(N.A,{placeholder:"请输入MCP服务链接",value:(()=>{try{return JSON.parse(e.value||"{}").mcp_servers||""}catch(e){return""}})(),onChange:n=>{let t={};try{t=JSON.parse(e.value||"{}")}catch(e){t={}}t.mcp_servers=n.target.value,O(l,"value",JSON.stringify(t))}})})]})},e.unique_id||e.id)),(0,t.jsx)(y.Ay,{type:"dashed",onClick:()=>{h([...x||[],{id:Date.now(),type:"tool(mcp(sse))",unique_id:null,name:"",value:"",isNew:!0}])},icon:(0,t.jsx)(R.A,{}),className:"w-full h-10 border-gray-300 hover:border-blue-400 hover:text-blue-400",children:"添加 MCP 配置"})]})]})})},P=["chat_in_layout","resource_sub_type","model_sub_type","temperature_sub_type","max_new_tokens_sub_type","resource_value","model_value"],z=["temperature_value","max_new_tokens_value"],q=function(){var e,l,n,i,f,h;let{appInfo:_,fetchUpdateApp:y,fetchUpdateAppLoading:b}=(0,u.useContext)(r.BR),[N]=m.A.useForm(),w=v.A.useApp().modal,[A,k]=(0,u.useState)(!1),[S,C]=(0,u.useState)(!1),[O,J]=(0,u.useState)(!1),[I,F]=(0,u.useState)(!1),[M,B]=(0,u.useState)(["0","1","2"]),[R,q]=(0,u.useState)([]),[L,T]=(0,u.useState)([]);(0,u.useEffect)(()=>{if(_){var e,l,n,t,a,r,o,s,i,u,c;let{resource_knowledge:p,resources:m,layout:v}=_||{},f=null==m?void 0:m.find(e=>"reasoning_engine"===e.type),h=x()(null==f?void 0:f.value)?(0,d.j)(null==f?void 0:f.value,{}):null==f?void 0:f.value,g=JSON.parse((null==p||null==(e=p[0])?void 0:e.value)||"{}"),y=null==g||null==(l=g.knowledges)?void 0:l.map(e=>({...e,value:e.knowledge_id,name:e.label||e.knowledge_name})),b=((null==_||null==(n=_.resource_tool)?void 0:n.filter(e=>"tool"===e.type))||[]).map(e=>{var l;let{value:n}=e||{};return null==(l=JSON.parse(n||"{}"))?void 0:l.key}),j=((null==_||null==(t=_.resource_agent)?void 0:t.map(e=>{var l;let{value:n}=e||{};return null==(l=JSON.parse(n||"{}"))?void 0:l.key}))||[]).filter(e=>e);q(y);let w=(null==_||null==(r=_.layout)||null==(a=r.chat_in_layout)?void 0:a.map(e=>e.param_type))||[],A={};w.forEach(e=>{var l;let n=null==_||null==(l=_.layout)?void 0:l.chat_in_layout.find(l=>l.param_type===e);A="resource"===e?{...A,resource_sub_type:n.sub_type,resource_value:n.param_default_value}:"model"===e?{...A,model_sub_type:n.sub_type,model_value:n.param_default_value}:"temperature"===e?{...A,temperature_sub_type:n.sub_type,temperature_value:n.param_default_value}:"max_new_tokens"===e?{...A,max_new_tokens_sub_type:n.sub_type,max_new_tokens_value:n.param_default_value}:{...A,[n]:{sub_type:n.sub_type,value:n.param_default_value}}}),N.setFieldsValue({app_name:_.app_name,app_icon:_.icon,app_describe:_.app_describe,llm_strategy:null==_||null==(o=_.llm_config)?void 0:o.llm_strategy,llm_strategy_value:(null==_||null==(s=_.llm_config)?void 0:s.llm_strategy_value)||[],knowledge:null==y?void 0:y.map(e=>e.value),tools:b,chat_layout:(null==_||null==(u=_.layout)||null==(i=u.chat_layout)?void 0:i.name)||"",chat_in_layout:w||[],agents:j,agent:_.agent,reasoning_engine:null!=(c=null==h?void 0:h.key)?c:null==h?void 0:h.name,...A})}},[_,N]);let{data:K,run:U}=(0,o.A)(async()=>await (0,a.PO)(),{manual:!0}),{data:H}=(0,o.A)(async()=>await (0,a.BN)({type:"reasoning_engine"})),{data:G,run:Z}=(0,o.A)(async()=>await (0,a.d_)(),{manual:!0}),{run:W,loading:X}=(0,o.A)(async e=>await (0,a.PS)([e]),{manual:!0,onSuccess:e=>{var l,n;let t=null==e||null==(n=e.data)||null==(l=n.data[0])?void 0:l.param_type_options;t&&T(t.map(e=>({...e,label:e.label,value:e.key||e.value})))}}),{data:Y=[]}=(0,o.A)(async()=>{let[,e]=await (0,a.Vb)((0,a.Tz)());return null!=e?e:[]});(0,u.useEffect)(()=>{var e,l;let n=null==_||null==(l=_.layout)||null==(e=l.chat_in_layout)?void 0:e.find(e=>"resource"===e.param_type);n&&W(n)},[null==(e=_.layout)?void 0:e.chat_in_layout]),(0,u.useEffect)(()=>{U(),Z()},[]);let Q=(0,u.useMemo)(()=>{var e,l;return null==K||null==(l=K.data)||null==(e=l.data)?void 0:e.map(e=>({...e,value:e.name,label:"".concat(e.description,"[").concat(e.name,"]")}))},[K]),$=(0,u.useMemo)(()=>{var e,l;return null==H||null==(l=H.data)||null==(e=l.data)?void 0:e.flatMap(e=>{var l;return(null==(l=e.valid_values)?void 0:l.map(e=>({item:e,value:e.key,label:e.label,selected:!0})))||[]})},[H]),ee=(0,u.useMemo)(()=>{var e,l;return null==G||null==(l=G.data)||null==(e=l.data)?void 0:e.map(e=>({...e,value:e.param_type,label:e.param_description}))},[G]),el=(0,u.useMemo)(()=>Y.map(e=>({value:e,label:e})),[Y]),en=()=>{let e=(N.getFieldValue("chat_in_layout")||[]).map(e=>{let{label:l,value:n,sub_types:t,...a}=(null==ee?void 0:ee.find(l=>e===l.param_type))||{};if("resource"===e){let e=N.getFieldValue("resource_sub_type")||null,l=N.getFieldValue("resource_value")||null;return{...a,param_default_value:l||null,sub_type:e}}if("model"===e){let e=N.getFieldValue("model_sub_type")||null,l=N.getFieldValue("model_value")||null;return{...a,param_default_value:l||null,sub_type:e}}if("temperature"===e){let e=N.getFieldValue("temperature_sub_type")||null,l=N.getFieldValue("temperature_value")||a.param_default_value||null;return{...a,param_default_value:Number(l)||null,sub_type:e}}{if("max_new_tokens"!==e)return ee.find(l=>e.includes(l.param_type))||{};let l=N.getFieldValue("max_new_tokens_sub_type")||null,n=N.getFieldValue("max_new_tokens_value")||a.param_default_value||null;return{...a,param_default_value:Number(n),sub_type:l}}}).filter(e=>Object.keys(e).length>0);y({..._,layout:{..._.layout,chat_in_layout:e}})};return(0,t.jsx)("div",{className:"flex-1 border-r-1 p-4 border-r-[#D9D9D9] h-full overflow-y-auto",children:(0,t.jsxs)(s.A,{spinning:b,wrapperClassName:"h-full w-full max-h-full",children:[(0,t.jsxs)("div",{className:"p-4 flex pt-1 flex-row items-center text-[18px]",children:[(0,t.jsxs)("div",{className:"flex flex-row items-center flex-1",children:[(0,t.jsx)(c.A,{className:"pr-2"}),(0,t.jsx)("h2",{className:"font-semibold",children:"配置"})]}),(0,t.jsx)("div",{className:"flex items-center gap-1 cursor-pointer transition-colors ml-auto",onClick:()=>{I?(B(["0","1","2"]),F(!1)):(B([]),F(!0))},children:(0,t.jsx)("img",{src:I?"/icons/collapsed.svg":"/icons/uncollapsed.svg",alt:"toggle",className:"w-5 h-5"})})]}),(0,t.jsxs)("div",{className:"overflow-y-auto flex-1",children:[(0,t.jsx)(m.A,{form:N,onValuesChange:e=>{var l,n;let[t]=Object.keys(null!=e?e:{}),[a]=Object.values(null!=e?e:{});if("icon"===t)y({..._,icon:a});else if("agent"===t)y({..._,agent:a});else if("llm_strategy"===t)y({..._,llm_config:{llm_strategy:a,llm_strategy_value:(null==(l=_.llm_config)?void 0:l.llm_strategy_value)||[]}});else if("llm_strategy_value"===t)y({..._,llm_config:{llm_strategy:N.getFieldValue("llm_strategy"),llm_strategy_value:a}});else if("chat_layout"===t){let e=Q.find(e=>e.value===a);y({..._,layout:{..._.layout,chat_layout:e}})}else if("reasoning_engine"===t){let e=null==$?void 0:$.find(e=>e.value===a);e&&y({..._,resources:g()([{type:"reasoning_engine",value:e.item},...null!=(n=_.resources)?n:[]],"type")})}else{if(!P.includes(t))return null;en()}},children:(0,t.jsx)(E,{form:N,activeKey:M,setActiveKey:B,setIsCollapsed:F,layoutDataOptions:Q,reasoningEngineOptions:$,chatConfigOptions:ee,handleChangedIcon:e=>{y({..._,icon:e})},onInputBlur:e=>{z.includes(e)?en():_[e]!==N.getFieldValue(e)&&y({..._,[e]:N.getFieldValue(e)})},resourceOptions:L,modelOptions:el})}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"p-4 flex flex-row items-center text-[18px] justify-between",children:[(0,t.jsxs)("div",{className:"flex flex-row items-center",children:[(0,t.jsx)("img",{src:"/icons/knowledge.svg",alt:"知识图标",style:{width:18,height:18,marginRight:8}}),(0,t.jsx)("h2",{className:"font-semibold",children:"知识"})]}),(0,t.jsx)("div",{className:"flex flex-row items-center text-[14px] text-[#0c75fc] cursor-pointer",children:(0,t.jsxs)("span",{className:"cursor-pointer flex items-center",onClick:()=>k(!0),children:[(0,t.jsx)("span",{className:"text-[16px] mr-1",children:"+"}),(0,t.jsx)("span",{children:"关联知识"})]})})]}),(null==_||null==(l=_.resource_knowledge)?void 0:l.length)>0?(0,t.jsx)("div",{children:null==R?void 0:R.map(e=>(0,t.jsx)("div",{className:"flex items-center justify-between py-2 border-gray-200 bg-[#F2F2F2] mb-1",children:(0,t.jsxs)("div",{className:"px-4 flex-row display flex flex-1 items-center justify-between",children:[(0,t.jsx)("div",{className:"flex-1",children:e.name}),(0,t.jsx)(p.A,{onClick:()=>(e=>{var l;let n=null==_||null==(l=_.resource_knowledge[0])?void 0:l.value,t=R.filter(l=>l.value!==e);w.confirm({title:"确认删除",content:"您确定要删除该知识吗？",onOk:()=>{let e=[{..._.resource_knowledge[0],value:JSON.stringify({...JSON.parse(n||"{}"),knowledges:t.map(e=>({knowledge_id:e.value,knowledge_name:e.name}))})}];y({..._,resource_knowledge:e}),q(t)}})})(e.value)})]})},e.name+e.id))}):""]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"p-4 flex flex-row items-center text-[18px] justify-between",children:[(0,t.jsxs)("div",{className:"flex flex-row items-center",children:[(0,t.jsx)("img",{src:"/icons/skill.svg",alt:"技能图标",style:{width:18,height:18,marginRight:8}}),(0,t.jsx)("h2",{className:"font-semibold",children:"技能"})]}),(0,t.jsx)("div",{className:"flex flex-row items-center text-[14px] text-[#0c75fc] cursor-pointer",children:(0,t.jsxs)("span",{className:"cursor-pointer flex items-center",onClick:()=>C(!0),children:[(0,t.jsx)("span",{className:"text-[16px] mr-1",children:"+"}),(0,t.jsx)("span",{children:"关联技能"})]})})]}),(null==_||null==(n=_.resource_tool)?void 0:n.length)>0?(0,t.jsx)("div",{children:null==_||null==(i=_.resource_tool)?void 0:i.map(e=>{var l,n;let{value:a}=e||{},r="tool"===e.type&&((null==(l=JSON.parse(a||"{}"))?void 0:l.name)||(null==(n=JSON.parse(a||"{}"))?void 0:n.label))||e.name;return(0,t.jsx)("div",{className:"flex items-center justify-between py-2 border-gray-200 bg-[#F2F2F2] mb-1",children:(0,t.jsxs)("div",{className:"px-4 flex-row display flex flex-1 items-center justify-between",children:[(0,t.jsx)("div",{className:"flex-1",children:r}),(0,t.jsx)(p.A,{onClick:()=>(e=>{var l,n;let t="tool"===e.type?(null==(l=JSON.parse(e.value||"{}"))?void 0:l.name)||(null==(n=JSON.parse(e.value||"{}"))?void 0:n.label):e.name;w.confirm({title:"确认删除",content:"您确定要删除".concat(t,"该工具吗？"),onOk:()=>{if("tool"===e.type){var l,n;let t=(null==(l=JSON.parse(e.value||"{}"))?void 0:l.name)||(null==(n=JSON.parse(e.value||"{}"))?void 0:n.label),a=_.resource_tool.filter(e=>{var l;return"tool"!==e.type||(null==(l=JSON.parse(e.value||"{}"))?void 0:l.key)!==t});y({..._,resource_tool:a})}else if("tool(mcp(sse))"===e.type){let l=_.resource_tool.filter(l=>"tool(mcp(sse))"!==l.type||l.name!==e.name);y({..._,resource_tool:l})}}})})(e)})]})},r+e.id)})}):""]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"p-4 flex flex-row items-center text-[18px] justify-between",children:[(0,t.jsxs)("div",{className:"flex flex-row items-center",children:[(0,t.jsx)("img",{src:"/icons/agent.svg",alt:"Agent图标",style:{width:18,height:18,marginRight:8}}),(0,t.jsx)("h2",{className:"font-semibold  text-[16px]",children:"Agent"})]}),(0,t.jsx)("div",{className:"flex flex-row items-center text-[14px] text-[#0c75fc] cursor-pointer",children:(0,t.jsxs)("span",{className:"cursor-pointer flex items-center justify-center",onClick:()=>J(!0),children:[(0,t.jsx)("span",{className:"text-[16px] mr-1",children:"+"}),(0,t.jsx)("span",{children:"关联Agent"})]})})]}),(null==_||null==(f=_.resource_agent)?void 0:f.length)>0?(0,t.jsx)("div",{children:null==_||null==(h=_.resource_agent)?void 0:h.map(e=>{var l,n;let{value:a}=e||{},r=(null==(l=JSON.parse(a||"{}"))?void 0:l.name)||(null==(n=JSON.parse(a||"{}"))?void 0:n.label);return(0,t.jsx)("div",{className:"flex items-center justify-between py-2 border-gray-200 bg-[#F2F2F2] mb-1",children:(0,t.jsxs)("div",{className:"px-4 flex-row display flex flex-1 items-center justify-between",children:[(0,t.jsx)("div",{className:"flex-1",children:r}),(0,t.jsx)(p.A,{onClick:()=>(e=>{var l,n;let t=(null==(l=JSON.parse(e.value||"{}"))?void 0:l.name)||(null==(n=JSON.parse(e.value||"{}"))?void 0:n.label);w.confirm({title:"确认删除",content:"您确定要删除".concat(t,"该Agent吗？"),onOk:()=>{var l;let n=null==(l=JSON.parse(e.value||"{}"))?void 0:l.key,t=_.resource_agent.filter(e=>{var l;return(null==(l=JSON.parse(e.value||"{}"))?void 0:l.key)!==n});y({..._,resource_agent:t})}})})(e)})]})},r+e.key)})}):""]}),A&&(0,t.jsx)(D,{form:N,visible:A,onKnowledgeChange:e=>{y({..._,resource_knowledge:e}),k(!1)},onCancel:()=>k(!1)}),S&&(0,t.jsx)(V,{form:N,visible:S,onCancel:()=>C(!1),onToolsChange:e=>{y({..._,resource_tool:e}),C(!1)}}),O&&(0,t.jsx)(j,{visible:O,onCancel:()=>J(!1),onAgentChange:e=>{y({..._,resource_agent:e}),J(!1)},form:N})]})]})})};var L=n(32195),T=n(7449),K=n(73603),U=n(12669),H=n(56200),G=n(90797),Z=n(15933),W=n(59694);function X(){let e=(0,Z._)(["\n  max-width: 287px;\n  /* padding: 4px; */\n  /* background-color: #fff; */\n  .custom_popover_content_name {\n    font-size: 14px;\n    color: #525964;\n    line-height: 22px;\n    font-weight: 600;\n  }\n  .custom_popover_content_desc {\n    font-size: 12px;\n    color: #000a1a78;\n    line-height: 22px;\n  }\n  .custom_popover_content_code {\n    max-height: 226px;\n    background: #f4f4f6;\n    border-radius: 10px;\n    margin-top: 8px;\n    .tech-highlight-light {\n      background: #f4f4f6;\n    }\n  }\n"]);return X=function(){return e},e}function Y(){let e=(0,Z._)(["\n  display: inline-block;\n  background: #1b62ff1a;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 14px;\n  color: #1b62ff;\n  line-height: 24px;\n  padding: 0px 6px;\n  margin: 2px;\n  img {\n    margin-right: 4px;\n  }\n"]);return Y=function(){return e},e}function Q(){let e=(0,Z._)(["\n  .ant-popover-inner {\n    background-image: linear-gradient(114deg, #3595ff 12%, #185cff 98%);\n  }\n  .ant-popover-arrow::before {\n    background: #3595ff;\n  }\n  .init_popover_content {\n    width: 205px;\n    /* padding: 4px; */\n    font-size: 14px;\n    color: #ffffff;\n    line-height: 24px;\n    font-weight: 500;\n    .ant-btn {\n      color: #1b62ff;\n      width: 100%;\n      margin-top: 8px;\n    }\n  }\n"]);return Q=function(){return e},e}let $=W.I4.div(X()),ee=W.I4.div(Y()),el=W.I4.span(Q()),en={knowledge:"/icons/knowledge_blue.png",skill:"/icons/skill_blue.svg",agent:"/icons/agent_blue.svg"},et=e=>{let{data:l}=e;return(0,t.jsx)(el,{children:(0,t.jsx)(H.A,{placement:"bottom",content:(0,t.jsxs)($,{children:[(0,t.jsx)("div",{className:"custom_popover_content_name",children:null==l?void 0:l.name}),(0,t.jsx)("div",{children:(null==l?void 0:l.description)&&(0,t.jsx)(G.A.Text,{className:"custom_popover_content_desc",ellipsis:{tooltip:null==l?void 0:l.description},children:(null==l?void 0:l.description)||""})})]}),children:(0,t.jsxs)(ee,{children:[(null==l?void 0:l.type)&&en[l.type]&&(0,t.jsx)("img",{style:{width:"16px"},src:en[l.type]}),(0,t.jsx)("span",{children:null==l?void 0:l.name})]})})})};class ea extends K.xO{eq(e){return JSON.stringify(this.data||{})===JSON.stringify(e.data||{})}toDOM(){let e=document.createElement("span");return U.createRoot(e).render((0,t.jsx)(et,{data:this.data})),e}ignoreEvent(){return!1}constructor(e,l){super(),this.data=e,this.handleClickChangeVariable=l}}function er(){let e=(0,Z._)(["\n  font-weight: 400;\n  font-size: 14px;\n  line-height: 24px;\n  transition: all 0.2s;\n  word-break: break-all;\n  height: 100%;\n  cursor: text;\n  flex: 1;\n  overflow-y: auto;\n  scrollbar-width: thin;\n  scrollbar-gutter: stable;\n  .cm-editor {\n    background: transparent;\n  }\n\n  .cm-content {\n    white-space: pre-wrap !important;\n    width: 100% !important;\n    line-height: 24px !important;\n    font-size: 14px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,\n      'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji',\n      'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  }\n\n  .cm-placeholder {\n    color: rgba(0, 10, 26, 26%) !important;\n  }\n\n  .cm-focused {\n    outline: none !important;\n  }\n"]);return er=function(){return e},e}let eo=W.I4.div(er()),es=e=>{var l,n;let t=null==e||null==(n=e.state)||null==(l=n.selection)?void 0:l.main;return null==e?void 0:e.coordsAtPos(null==t?void 0:t.head)},ei=e=>{let l=e.state.selection.main;return{from:l.from,to:l.to}},eu=u.memo(e=>{let{value:l,readonly:n,placeholder:a,onChange:r,variableList:o=[],style:s,setReasoningArgSuppliers:i,reasoningArgSuppliers:d=[],skillList:c=[],agentList:p=[],knowledgeList:m=[],className:v,teamMode:f}=e,[x,h]=(0,u.useState)(),[g,_]=(0,u.useState)(null),y=(0,u.useRef)(null),[b,j]=(0,u.useState)(!1),[N,w]=(0,u.useState)(!1),[A,k]=(0,u.useState)({}),S=[(e=>{let{skillList:l,agentList:n,knowledgeList:t}=e,a=new K.dT({regexp:RegExp("{#LibraryBlock(?<attrs>[^#]*)#}(?<content>[^#]+){#\\/LibraryBlock#}","g"),decoration:e=>{var a,r,o;let s=null==(a=e.groups)?void 0:a.attrs,i=(null==(r=e.groups)?void 0:r.content)||"",u=(null==s||null==(o=s.match(/type="([^"]+)"/))?void 0:o[1])||"",d={name:i,description:"",type:u};if("skill"===u){let e=null==l?void 0:l.find(e=>(null==e?void 0:e.title)===i);d.description=null==e?void 0:e.description}else if("agent"===u){let e=null==n?void 0:n.find(e=>(null==e?void 0:e.title)===i);d.description=null==e?void 0:e.description}else if("knowledge"===u){let e=null==t?void 0:t.find(e=>(null==e?void 0:e.name)===i);d.description=null==e?void 0:e.description}return K.NZ.replace({widget:new ea(d)})}});return K.Z9.fromClass(class{update(e){this.placeholders=a.updateDeco(e,this.placeholders)}constructor(e){this.placeholders=a.createDeco(e)}},{decorations:e=>e.placeholders,provide:e=>K.Lz.atomicRanges.of(l=>{var n;return(null==(n=l.plugin(e))?void 0:n.placeholders)||K.NZ.none})})})({skillList:c,agentList:p,knowledgeList:m})],C=(0,L.a)({theme:"light",settings:{background:"#ffffff",backgroundImage:"",caret:"#000",selection:"#afd1ff",gutterBackground:"#fff",gutterForeground:"#8a919966",fontSize:14},styles:[]}),O=e=>{let l=y.current;l&&!n&&setTimeout(()=>{var n,t,a;let r=ei(l),o=null==l||null==(a=l.state)||null==(t=a.doc)||null==(n=t.toString())?void 0:n.slice(r.from,r.to+1);(null==e?void 0:e.key)==="{"?(h({...r,from:r.from-1,to:"}"===o?r.to+1:r.to}),_(es(l)),j(!0)):(j(!1),h(r))})},J=e=>{let l=y.current;if(!l||n)return;let t=ei(l),a=es(l),r=document.querySelector(".ant-modal-root"),o=document.querySelector(".custom-command-modal"),s=document.querySelector(".custom-choose-modal"),i=!1;(o&&(null==o?void 0:o.contains(null==e?void 0:e.target))||r&&(null==r?void 0:r.contains(null==e?void 0:e.target))||s&&(null==s?void 0:s.contains(null==e?void 0:e.target)))&&(i=!0),i||(j(!1),_(a),h(t))};return(0,u.useEffect)(()=>()=>{if(document.removeEventListener("mouseup",J),y.current){var e,l;null==(l=y.current)||null==(e=l.dom)||e.removeEventListener("keydown",O)}},[]),(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)(eo,{style:s,className:v,children:[(0,t.jsx)("div",{className:"custom-choose"}),(0,t.jsx)(T.Ay,{theme:C,className:"InputCodeMirror",readOnly:n,value:l,onChange:e=>{r&&r(e)},onCreateEditor:e=>{var l;y.current=e,null==e||null==(l=e.dom)||l.addEventListener("keydown",O),document.addEventListener("mouseup",J)},placeholder:a,basicSetup:{lineNumbers:!1,highlightActiveLineGutter:!1,foldGutter:!1,autocompletion:!1,indentOnInput:!1,highlightActiveLine:!1,highlightSelectionMatches:!1},extensions:[S],height:"100%",style:{fontSize:14,height:"100%",minHeight:"200px"}})]})})});var ed=n(51157),ec=n(50715),ep=n(45964),em=n.n(ep);let ev=function(){let{collapsed:e,setCollapsed:l,appInfo:n,refreshAppInfo:s}=(0,u.useContext)(r.BR),{system_prompt_template:i="",user_prompt_template:d=""}=n||{},{run:c}=(0,o.A)(async e=>await (0,a.fy)(e),{manual:!0,onSuccess:()=>{s&&s()}}),{run:p}=(0,ec.A)(e=>c({...n,system_prompt_template:e}),{wait:500}),{run:m}=(0,ec.A)(e=>c({...n,user_prompt_template:e}),{wait:500}),v=em()(e=>{p(e)},800),f=em()(e=>{m(e)},800),x=(0,u.useMemo)(()=>i||"",[i]),h=(0,u.useMemo)(()=>d||"",[d]),g=[{label:"系统提示词",children:(0,t.jsx)(eu,{value:x,onChange:v})},{label:"用户提示词",children:(0,t.jsx)(eu,{value:h,onChange:f})}];return(0,t.jsxs)("div",{className:"flex-1 border-r-1 p-4 relative border-r-[#D9D9D9] h-full flex flex-col",children:[(0,t.jsx)("div",{className:"p-4 pt-1",children:(0,t.jsx)("h2",{className:"font-semibold text-[18px]",children:"提示词设定"})}),(0,t.jsx)("div",{className:"[&_.ant-collapse-header-text]:font-bold overflow-y-auto flex-1",children:(0,t.jsx)(A.A,{items:g,bordered:!1,collapsible:"header",defaultActiveKey:["0","1"]})}),(0,t.jsx)("button",{onClick:()=>l(!e),className:"absolute top-1/2 right-[-10px] bg-[#f3f5f9] transform -translate-y-1/2 px-1 pr-4 rounded-[24px]  w-5 h-10 border-[#D9D9D9] border-[1px]",children:(0,t.jsx)(ed.A,{className:"w-8 h-8",onClick:()=>l(!e)})})]})};var ef=n(86253),ex=n(9409),eh=n(93640),eg=n(47937),e_=n(54819);let{Content:ey}=ef.A,eb=function(){var e;let{appInfo:l,setCollapsed:n,collapsed:a,refreshAppInfo:o,chatId:s}=(0,u.useContext)(r.BR),[i,d]=(0,u.useState)([]),[c]=(0,u.useState)(),[p,m]=(0,u.useState)(!1),[v,f]=(0,u.useState)(!1),[x,h]=(0,u.useState)(""),[g,_]=(0,u.useState)(.6),[y,b]=(0,u.useState)(4e3),[j,N]=(0,u.useState)(),[w,A]=(0,u.useState)([]),[k,S]=(0,u.useState)(""),C=(0,u.useRef)(null),[O]=(0,u.useState)(null),{chat:J,ctrl:I}=(0,eh.A)({app_code:l.app_code||""}),F=(0,u.useRef)(1),E=(0,u.useCallback)((e,t)=>new Promise(a=>{var r,o,u,c,p,v;let x=(0,eg.oF)(),h=new AbortController;if(setTimeout(()=>{n(!0)},50),m(!0),i&&i.length>0){let e=null==i?void 0:i.filter(e=>"view"===e.role),l=null==i?void 0:i.filter(e=>"human"===e.role);F.current=((null==(p=e[e.length-1])?void 0:p.order)||(null==(v=l[l.length-1])?void 0:v.order))+1}let g="";if("string"==typeof e)g=e;else{let l=e.content||[],n=l.filter(e=>"text"===e.type),t=l.filter(e=>"text"!==e.type);n.length>0&&(g=n.map(e=>e.text).join(" "));let a=t.map(e=>{if("image_url"===e.type){var l,n;let t=(null==(l=e.image_url)?void 0:l.url)||"",a=(0,eg.sC)(t),r=(null==(n=e.image_url)?void 0:n.fileName)||"image";return"\n![".concat(r,"](").concat(a,")")}if("video"===e.type){let l=e.video||"",n=(0,eg.sC)(l);return"\n[Video](".concat(n,")")}{let l=(0,eg.UX)(e.file_url);return"\n".concat(l)}}).join("\n");a&&(g=g+"\n"+a)}let _=[...x&&x.id===s?[]:i,{role:"human",context:g,model_name:(null==t?void 0:t.model_name)||k,order:F.current,time_stamp:0},{role:"view",context:"",model_name:(null==t?void 0:t.model_name)||k,order:F.current,time_stamp:0,thinking:!0}],y=_.length-1;d([..._]),J({data:{user_input:e,team_mode:(null==l?void 0:l.team_mode)||"",app_config_code:(null==l?void 0:l.config_code)||"",conv_uid:s,ext_info:{vis_render:(null==l||null==(o=l.layout)||null==(r=o.chat_layout)?void 0:r.name)||"",incremental:(null==l||null==(c=l.layout)||null==(u=c.chat_layout)?void 0:u.incremental)||!1},...t},ctrl:h,onMessage:e=>{f(!0),e&&((null==t?void 0:t.incremental)?_[y].context+=e:_[y].context=e,_[y].thinking=!1,d([..._]))},onDone:()=>{m(!1),f(!1),a()},onClose:()=>{m(!1),f(!1),a()},onError:e=>{m(!1),f(!1),_[y].context=e,_[y].thinking=!1,d([..._]),a()}})}),[i,k,J,l,s]);return(0,u.useEffect)(()=>{var e,n,t;if(null==l||null==(n=l.layout)||null==(e=n.chat_in_layout)?void 0:e.length){let e=null==l||null==(t=l.layout)?void 0:t.chat_in_layout,n=e.find(e=>"temperature"===e.param_type),a=e.find(e=>"max_new_tokens"===e.param_type),r=e.find(e=>"resource"===e.param_type),o=e.find(e=>"model"===e.param_type);_(Number(null==n?void 0:n.param_default_value)||.6),b(Number(null==a?void 0:a.param_default_value)||4e3),S((null==o?void 0:o.param_default_value)||""),N((null==r?void 0:r.param_default_value)||null),A([...n?[{param_type:"temperature",param_value:JSON.stringify(null==n?void 0:n.param_default_value),sub_type:null==n?void 0:n.sub_type}]:[],...a?[{param_type:"max_new_tokens",param_value:JSON.stringify(null==a?void 0:a.param_default_value),sub_type:null==a?void 0:a.sub_type}]:[],...r?[{param_type:"resource",param_value:JSON.stringify(null==r?void 0:r.param_default_value),sub_type:null==r?void 0:r.sub_type}]:[],...o?[{param_type:"model",param_value:JSON.stringify(null==o?void 0:o.param_default_value),sub_type:null==o?void 0:o.sub_type}]:[]])}},[null==l||null==(e=l.layout)?void 0:e.chat_in_layout]),(0,t.jsx)(r.zo.Provider,{value:{history:i,replyLoading:p,scrollRef:C,canAbort:v,chartsData:c||[],agent:x,currentDialogue:O,appInfo:l,temperatureValue:g,maxNewTokensValue:y,resourceValue:j,modelValue:k,setModelValue:S,setResourceValue:N,setTemperatureValue:_,setMaxNewTokensValue:b,setChatInParams:A,chatInParams:w,setAgent:h,setCanAbort:f,setReplyLoading:m,handleChat:E,refreshHistory:()=>{},refreshAppInfo:null!=o?o:()=>{},setHistory:d,isShowDetail:a,isDebug:!0,setAppInfo:()=>{},refreshDialogList:()=>{}},children:(0,t.jsxs)("div",{className:"flex-1 flex flex-row h-full transition-all duration-300",children:[a&&(0,t.jsx)("div",{className:"flex flex-col items-center justify-center pl-2",children:(0,t.jsx)("button",{onClick:()=>n(!a),className:"w-5 h-10 border-[1px] bg-[#f3f5f9] border-[#D9D9D9] pl-1 rounded-[24px] transform -translate-y-1/",children:(0,t.jsx)(e_.A,{})})}),(0,t.jsx)("div",{className:"flex-1 h-full",children:(0,t.jsx)(ey,{className:"flex flex-col flex-1 h-full",children:(0,t.jsx)(ex.A,{ref:C,ctrl:I})})})]})})};var ej=n(90765),eN=n(15742),ew=n(37152),eA=n(82343);let ek=function(){let{modal:e}=v.A.useApp(),[l,n]=(0,u.useState)(!1),{appInfo:s,queryAppInfo:d,refreshAppInfo:c,fetchUpdateAppLoading:p,refreshAppInfoLoading:m,setAppInfo:f,refetchVersionData:x,versionData:h}=(0,u.useContext)(r.BR),g=(0,i.useRouter)(),{runAsync:y,loading:b}=(0,o.A)(async e=>await (0,a.LU)(e),{manual:!0,onSuccess:async()=>{e.success({content:"应用发布成功"}),"function"==typeof c&&await c(),"function"==typeof x&&await x()},onError:()=>{e.error({content:"应用发布失败，请稍后重试"})}}),j=async()=>{"function"==typeof c&&(await y(s),n(!1))},N=(0,u.useMemo)(()=>{var e,l,n;return(null==h||null==(n=h.data)||null==(l=n.data)||null==(e=l.items)?void 0:e.map((e,l)=>({...e,key:e.version_info,label:(0,t.jsxs)("span",{className:e.version_info===(null==s?void 0:s.config_version)?"font-bold text-[#1677ff]":"",children:[e.version_info,e.version_info===(null==s?void 0:s.config_version)&&(0,t.jsx)(ej.A,{className:"ml-1 text-[green]"})]})})))||[{}]},[h,null==s?void 0:s.config_version]),w=async e=>{var l,n;let t=null==h||null==(n=h.data)||null==(l=n.data)?void 0:l.items.find(l=>l.version_info===e.key);t&&"function"==typeof d&&d(s.app_code,t.code)};return(0,t.jsxs)("div",{className:"flex items-center justify-between w-full px-4 py-2 border-b border-b-[#D9D9D9]",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,t.jsx)("button",{onClick:()=>g.replace("/application/app"),className:"p-2 rounded hover:bg-gray-200","aria-label":"返回",children:(0,t.jsx)("span",{className:"text-xl",children:"←"})}),(0,t.jsx)("img",{src:s.icon||"/agents/agent1.jpg",alt:"App Icon",className:"w-10 h-10 rounded"}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"flex flex-row items-center space-x-2",children:[(0,t.jsx)("div",{className:"font-semibold text-lg",children:(null==s?void 0:s.app_name)||"--"}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["已自动保存：",(null==s?void 0:s.updated_at)?s.updated_at:"--"]})]}),(null==s?void 0:s.config_version)&&N.length>0&&(0,t.jsx)(eA.A,{menu:{items:N,onClick:w},children:(0,t.jsxs)("button",{onClick:e=>e.preventDefault(),className:"text-xs text-gray-500 hover:bg-[#f3f5f9] cursor-pointer rounded p-1",children:[(0,t.jsx)(eN.A,{className:"mr-1"}),null==s?void 0:s.config_version]})}),(null==s?void 0:s.config_version)&&N.length<=0&&(0,t.jsx)("button",{className:"text-xs text-gray-500 hover:bg-[#f3f5f9]  rounded p-1",children:null==s?void 0:s.config_version})]})]}),(0,t.jsx)("button",{className:"ant-btn  ant-btn-default ant-btn-color-default ant-btn-variant-outlined border-none text-white bg-button-gradient flex items-center cursor-pointer px-5 py-1 rounded hover:bg-button-hover transition-colors duration-200",onClick:()=>n(!0),children:"发布"}),(0,t.jsx)(_.A,{title:(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(ew.A,{style:{color:"#faad14"}}),"发布应用"]}),open:l,onCancel:()=>n(!1),okButtonProps:{loading:m||p||b},onOk:j,children:(0,t.jsx)("div",{className:"pl-6",children:"确定要发布该应用吗？"})})]})};function eS(){var e;let{message:l,notification:n}=v.A.useApp(),[d,c]=(0,u.useState)(!1),[p,m]=(0,u.useState)({}),[f,x]=(0,u.useState)(null),[h,g]=(0,u.useState)(""),_=(0,i.useSearchParams)().get("app_code"),y=(0,u.useRef)(null);(0,u.useEffect)(()=>{_&&(b(_),S(_))},[_]);let{run:b,refresh:j,loading:N}=(0,o.A)(async(e,l)=>await (0,a.Vb)((0,a.Y6)({app_code:e,config_code:l}),n),{manual:!0,onSuccess:e=>{let[,l]=e;m(l||{})}}),{run:w,loading:A}=(0,o.A)(async e=>await (0,a.Vb)((0,a.fy)(e),n),{manual:!0,onSuccess:e=>{let[,n]=e;if(!n)return void l.error("应用更新失败，请稍后重试");m(n||{})},onError:e=>{l.error("应用更新失败，请稍后重试"),console.log("update app error",e)}}),{refreshAsync:k}=(0,o.A)(async()=>await (0,a.su)({app_code:p.app_code}),{manual:!(null==p?void 0:p.app_code),ready:!!(null==p?void 0:p.app_code),refreshDeps:[null!=(e=null==p?void 0:p.app_code)?e:""],onSuccess:e=>{x(e)}}),S=async e=>{let[,l]=await (0,a.Vb)((0,a.j_)({app_code:e}),n);l&&g(l.conv_uid)};return(0,t.jsx)(r.BR.Provider,{value:{collapsed:d,setCollapsed:c,appInfo:p,setAppInfo:m,refreshAppInfo:j,queryAppInfo:b,refreshAppInfoLoading:N,chatId:h,fetchUpdateApp:w,fetchUpdateAppLoading:A,refetchVersionData:k,versionData:f},children:(0,t.jsx)(s.A,{spinning:N,wrapperClassName:"h-screen w-full",children:(0,t.jsxs)("div",{className:"flex flex-col h-full",children:[(0,t.jsx)(ek,{}),(0,t.jsxs)("div",{className:"flex flex-1 flex-row overflow-hidden",ref:y,children:[!d&&(0,t.jsx)(q,{}),!d&&(0,t.jsx)(ev,{}),(0,t.jsx)(eb,{})]})]})})})}},99490:(e,l,n)=>{Promise.resolve().then(n.bind(n,73332))}},e=>{e.O(0,[562,240,5600,2826,7330,4935,4316,8779,3930,3485,5033,6079,1846,4925,7985,797,6939,9595,2343,5566,6467,2570,7744,5887,2275,5719,9211,6174,8709,7942,7514,5532,3001,1070,4496,5464,8441,5964,7358],()=>e(e.s=99490)),_N_E=e.O()}]);